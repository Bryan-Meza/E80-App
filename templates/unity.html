{% extends "base.html" %}

{% block title %}Unity Screenshots - Electtric E80{% endblock %}

{% block extra_css %}
<style>
  .unity-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }
  
  .unity-header {
    text-align: center;
    margin-bottom: 30px;
  }
  
  .unity-header h2 {
    color: #ffd700;
    margin-bottom: 10px;
  }
  
  .status-indicator {
    display: inline-block;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 14px;
    margin: 10px 0;
  }
  
  .status-connected {
    background-color: rgba(0, 255, 0, 0.2);
    color: #00ff00;
    border: 1px solid #00ff00;
  }
  
  .status-disconnected {
    background-color: rgba(255, 0, 0, 0.2);
    color: #ff0000;
    border: 1px solid #ff0000;
  }
  
  .screenshots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  
  .screenshot-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: transform 0.3s ease;
  }
  
  .screenshot-card:hover {
    transform: translateY(-5px);
  }
  
  .screenshot-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
  }
  
  .screenshot-info {
    color: #ccc;
    font-size: 12px;
  }
  
  .refresh-button {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #000;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-weight: bold;
    margin: 20px auto;
    display: block;
    transition: all 0.3s ease;
  }
  
  .refresh-button:hover {
    background: linear-gradient(135deg, #ffed4e, #ffd700);
    transform: scale(1.05);
  }
  
  .no-screenshots {
    text-align: center;
    color: #666;
    margin: 50px 0;
  }
  
  .latest-screenshot {
    margin-bottom: 30px;
    text-align: center;
  }
  
  .latest-screenshot img {
    max-width: 100%;
    max-height: 400px;
    border-radius: 10px;
    border: 2px solid #ffd700;
  }
</style>
{% endblock %}

{% block content %}
<main class="unity-container">
  <div class="unity-header">
    <h2><i class="fa-solid fa-video"></i> Unity Live Stream</h2>
    <div id="connectionStatus" class="status-indicator status-disconnected">
      <i class="fa-solid fa-circle"></i> Checking connection...
    </div>
    <button class="refresh-button" onclick="loadLiveStream()">
      <i class="fa-solid fa-bolt"></i> Refresh Live Stream
    </button>
  </div>

  <div id="latestScreenshot" class="latest-screenshot" style="display: none;">
    <h3><i class="fa-solid fa-bolt"></i> HYPER SPEED Live Stream</h3>
    <img id="latestImage" src="" alt="Live stream from Unity" style="max-width: 100%; max-height: 500px; border-radius: 10px; border: 2px solid #00ff00;">
    <p id="latestTimestamp" style="color: #00ff00; font-weight: bold;"></p>
  </div>

  <div id="screenshotsContainer">
    <div class="no-screenshots">
      <i class="fa-solid fa-image" style="font-size: 48px; color: #666; margin-bottom: 20px;"></i>
      <p>No screenshots received yet.</p>
      <p>Make sure Unity is running and sending screenshots to:</p>
      <code>http://localhost:5000/api/upload</code>
    </div>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
let lastScreenshotCount = 0;

function formatTimestamp(timestamp) {
  const date = new Date(timestamp * 1000);
  return date.toLocaleString();
}

function updateConnectionStatus(connected) {
  const statusElement = document.getElementById('connectionStatus');
  if (connected) {
    statusElement.className = 'status-indicator status-connected';
    statusElement.innerHTML = '<i class="fa-solid fa-circle"></i> Live Stream Active';
  } else {
    statusElement.className = 'status-indicator status-disconnected';
    statusElement.innerHTML = '<i class="fa-solid fa-circle"></i> No Live Stream';
  }
}

function loadLiveStream() {
  // Usar live stream en memoria para m√°xima velocidad
  fetch('/api/live-frame')
    .then(response => response.json())
    .then(data => {
      const latestContainer = document.getElementById('latestScreenshot');
      const container = document.getElementById('screenshotsContainer');
      
      if (data.live && data.frame) {
        updateConnectionStatus(true);
        
        // Mostrar frame en vivo desde memoria
        const imgSrc = 'data:image/jpeg;base64,' + data.frame;
        document.getElementById('latestImage').src = imgSrc;
        document.getElementById('latestTimestamp').textContent = 
          `üî¥ LIVE - ${new Date().toLocaleTimeString()}`;
        latestContainer.style.display = 'block';
        
        container.innerHTML = '<div style="text-align: center; color: #00ff00;"><i class="fa-solid fa-video"></i> LIVE STREAM ACTIVE - HYPER SPEED MODE</div>';
        
      } else {
        updateConnectionStatus(false);
        latestContainer.style.display = 'none';
        container.innerHTML = `
          <div class="no-screenshots">
            <i class="fa-solid fa-video-slash" style="font-size: 48px; color: #666; margin-bottom: 20px;"></i>
            <p>No live stream active.</p>
            <p>Use HyperSpeedStreamer.cs and connect to:</p>
            <code>http://localhost:5000/api/live</code>
          </div>
        `;
      }
    })
    .catch(error => {
      updateConnectionStatus(false);
    });
}

// Fallback a screenshots si live stream no est√° disponible
function loadScreenshots() {
  loadLiveStream(); // Siempre intentar live stream primero
}

// Load screenshots on page load
document.addEventListener('DOMContentLoaded', loadLiveStream);

// Auto-refresh H√çPER R√ÅPIDO (100ms = 10fps de actualizaci√≥n web)
setInterval(loadLiveStream, 100);
</script>
{% endblock %}
